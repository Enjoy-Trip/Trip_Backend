<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trip.attraction.mapper.AttractionMapper">
	<resultMap type="attractionDto" id="attractionSimple">
		<result column="contentid" property="contentid" />
		<result column="contenttypeid" property="contenttypeid" />
		<result column="title" property="title" />
		<result column="addr1" property="addr1" />
		<result column="addr2" property="addr2" />
		<result column="zipcode" property="zipcode" />
		<result column="tel" property="tel" />
		<result column="firstimage" property="firstimage" />
		<result column="firstimage2" property="firstimage2" />
		<result column="areacode" property="areacode" />
		<result column="sigungucode" property="sigungucode" />
		<result column="mapx" property="mapx" />
		<result column="mapy" property="mapy" />
		<result column="mlevel" property="mlevel" />
	</resultMap>

	<resultMap type="attractionDto" id="attractionDetail">
		<result column="contentid" property="contentid" />
		<result column="contenttypeid" property="contenttypeid" />
		<result column="title" property="title" />
		<result column="addr1" property="addr1" />
		<result column="addr2" property="addr2" />
		<result column="zipcode" property="zipcode" />
		<result column="tel" property="tel" />
		<result column="firstimage" property="firstimage" />
		<result column="firstimage2" property="firstimage2" />
		<result column="areacode" property="areacode" />
		<result column="sigungucode" property="sigungucode" />
		<result column="mapx" property="mapx" />
		<result column="mapy" property="mapy" />
		<result column="mlevel" property="mlevel" />
		<result column="homepage" property="homepage" />
		<result column="overview" property="overview" />
		<result column="telname" property="telname" />
		<result column="cat1" property="cat1" />
		<result column="cat2" property="cat2" />
		<result column="cat3" property="cat3" />
		<result column="createdtime" property="createdtime" />
		<result column="modifiedtime" property="modifiedtime" />
		<result column="booktour" property="booktour" />
		<collection property="attractionCommentList"
			column="contentid = contentid" select="getCommentList" javaType="List"
			ofType="comment" />
	</resultMap>
	
	<resultMap type="attractionCommentDto" id="comment">
		<result column="attraction_comment_no" property="attractionCommentNo" />
		<result column="contentid" property="contentid" />
		<result column="attraction_comment_content" property="attractionCommentContent" />
		<result column="attraction_comment_time" property="attractionCommentTime" />
		<association property="attractionCommentUser" javaType="UserDto">
			<result column="user_no" property="userNo" />
			<result column="user_id" property="userId" />
			<result column="user_name" property="userName" />
			<result column="user_profile" property="userProfile" />
		</association>
	</resultMap>
	
	<select id="getCommentList" resultMap="comment">
		select 
			c.attraction_comment_no attraction_comment_no,
			c.contentid contentid,
			c.attraction_comment_content attraction_comment_content,
			c.attraction_comment_time attraction_comment_time,
			u.user_no user_no,
			u.user_id user_id,
			u.user_name user_name,
			u.user_profile user_profile
		from 
			attraction_comment c
			inner join 
			user u
		on 
			c.user_no = u.user_no
		where 
			contentid = #{contentid}
	</select>
	
	<select id="attractionList" parameterType="map" resultMap="attractionSimple">
		select
			contentid,
			contenttypeid,
			title,
			addr1,
			addr2,
			zipcode,
			tel,
			firstimage,
			firstimage2,
			areacode,
			sigungucode,
			mapx,
			mapy,
			mlevel
		from
			attraction_info
		where
			1 = 1
			<if test="areacode != null and areacode != '' and areacode != 'null'">
				and areacode = #{areacode}
			</if> 			
			<if test="sigungucode != null and sigungucode != '' and sigungucode != 'null'">
				and sigungucode = #{sigungucode}
			</if>
			<if test="contenttypeid != null and contenttypeid != '' and contenttypeid != 'null'">
				and contenttypeid = #{contenttypeid}
			</if>
			<if test="keyword != null and keyword != '' and keyword != 'null'">
				and title like concat('%', #{keyword}, '%') or addr1 like concat('%', #{keyword}, '%') or addr2 like concat('%', #{keyword}, '%')
			</if>
	</select>
	
	<select id="attractionDetail" parameterType="map" resultMap="attractionDetail">
		select
			ai.contentid contentid,
			ai.contenttypeid contenttypeid,
			ai.title title,
			ai.addr1 addr1,
			ai.addr2 addr2,
			ai.zipcode zipcode,
			ai.tel tel,
			ai.firstimage firstimage,
			ai.firstimage2 firstimage2,
			ai.areacode areacode,
			ai.sigungucode sigungucode,
			ai.mapx mapx,
			ai.mapy mapy,
			ai.mlevel mlevel,
			adesc.homepage homepage,
			adesc.overview overview,
			adesc.telname telname,
			ad.cat1 cat1,
			ad.cat2 cat2,
			ad.cat3 cat3,
			ad.createdtime createdtime,
			ad.modifiedtime modifiedtime,
			ad.booktour booktour
		from
			attraction_info ai
			inner join
			attraction_detail_info ad
			inner join
			attraction_description adesc
		on
			ai.contentid = ad.contentid
			and
			ai.contentid = adesc.contentid
		where
			ai.contentid = #{contentid}
	</select>
	
	<insert id="writeComment" parameterType="attractionCommentDto">
		insert into 
			attraction_comment (user_no, contentid, attraction_comment_content) 
		values 
			(#{attractionCommentUser.userNo}, #{contentid}, #{attractionCommentContent})
	</insert>
	
	<update id="updateComment" parameterType="attractionCommentDto">
		update
			attraction_comment
		set
			attraction_comment_content = #{attractionCommentContent}
		where
			attraction_comment_no = #{attractionCommentNo}
	</update>
	
	<delete id="deleteComment" parameterType="int">
		delete from 
			attraction_comment
		where
			attraction_comment_no = #{attractionCommentNo}
	</delete>
</mapper>